# 2024

## Waiting for selector `feed-item` failed

```sh
=== /process-data API called
puppeteer page ready
Error while scraping: TimeoutError: Waiting for selector `feed-item` failed: Waiting failed: 30000ms exceeded
```

The page is using a custom web component (c-wiz) which is part of Google's modern web architecture. Let's update the selector strategy to handle this structure. Here's the modified code:

## Auth

I have a Django Rest Framework app that communicates with a React frontend which also has to use this projects APIs.  I want to be able to share the auth from that project to protect these routes using that same auth.  That DRF app has these INSTALLED_APPS:

```py
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'cloudinary_storage',
    'django.contrib.staticfiles',
    'cloudinary',
    'rest_framework',
    'django_filters',
    'rest_framework.authtoken',
    'dj_rest_auth',
    'corsheaders',
    'django.contrib.sites',
    'allauth',
    'allauth.account',
    'allauth.socialaccount',
    'dj_rest_auth.registration',
    ...
```

### Auth Guard

implement a custom authentication guard in NestJS that validates the tokens issued by the DRF application.

Verify token with your Django backend

```js
const response = await axios.get(
  'http://your-django-api/api/auth/verify/', // Adjust this URL to your Django verification endpoint
        {
          headers: {
            Authorization: `Token ${token}`, // or `Bearer ${token}` depending on your setup
          },
        }
);
```

The DRF app uses this API to authenticate the user:

```txt
Request URL: https://drf-two-eb17ecbff99f.herokuapp.com/dj-rest-auth/token/refresh/
Request Method: POST
```

We use a JWT guard to validate the token from your DRF app. Here's how to update it.

## Heroku Deployment

```sh
heroku create google-trend-predictor

heroku buildpacks:add jontewks/puppeteer -a google-trend-predictor

# Add Puppeteer buildpack
heroku buildpacks:add jontewks/puppeteer

# 2. Add Node.js buildpack
heroku buildpacks:add heroku/nodejs
```

### Update your package.json

```json
{
  "scripts": {
    "start": "node dist/main.js",
    "postinstall": "npm run build",
    "build": "nest build"
  },
  "engines": {
    "node": "16.20.0"
  }
}

### Modify your google-trends.service.ts

### Add Procfile

```Procfile
web: npm run start
```

### Deploy

Using the new deployment in the frontend fails:

```txt
https://google-trend-predictor-445bdeb27571.herokuapp.com/parse-realtime-data
Request Method: GET
Status Code: 503 Service Unavailable
```

To view the logs, on the app Heroku Dashboard "More" menu in the top right select "View logs" from the dropdown.

```sh
2024-12-17T00:50:31.142398+00:00 heroku[web.1]: Starting process with command `npm run start`
2024-12-17T00:50:31.655870+00:00 app[web.1]: /bin/bash: line 1: npm: command not found
2024-12-17T00:50:31.704499+00:00 heroku[web.1]: Process exited with status 127
2024-12-17T00:50:31.725356+00:00 heroku[web.1]: State changed from starting to crashed
2024-12-17T01:58:06.124594+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=dcd0d1b6-1ff0-443f-a9fa-b9d25b216ed0 fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
2024-12-17T01:58:07.416130+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=f1ab1f4d-d551-4cd9-adce-df31284e61ec fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
2024-12-17T01:58:09.676222+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=9cfa3ec9-65d0-4575-874f-aff0636d28a4 fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
2024-12-17T01:58:09.890398+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/parse-realtime-dataRequest%20Method:GETStatus%20Code:503%20Service%20Unavailable" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=c1df547f-22bc-4f11-86c8-29726d648df5 fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
2024-12-17T01:58:11.105720+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/parse-realtime-dataRequest%20Method:GETStatus%20Code:503%20Service%20Unavailable" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=7e307c57-c46d-4879-ab89-afe6064a3787 fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
2024-12-17T01:58:13.786707+00:00 heroku[router]: at=error code=H10 desc="App crashed" method=GET path="/parse-realtime-dataRequest%20Method:GETStatus%20Code:503%20Service%20Unavailable" host=google-trend-predictor-445bdeb27571.herokuapp.com request_id=b0a97f75-9013-4cb9-827a-f77ef0796efe fwd="3.83.192.252" dyno= connect= service= status=503 bytes= protocol=https
```

### Remove existing buildpacks

- Go to your app's Settings in Heroku Dashboard
- Scroll to "Buildpacks" section
- Click the "X" next to each existing buildpack to remove them all
- Add buildpacks in this specific order: the official nodejs and then jontewks/puppeteer buildpacks.

### Update your Procfile to use node directly

```Procfile
web: node dist/main.js
```

### Update the package.json to use node directly

```json
  "scripts": {
    ...
    "start": "node dist/main.js",
```

### Build Timeout Expired

```sh
-----> Installing dependencies
       Installing node modules
-----> Timed out running buildpack Node.js
 !     Push failed
ERROR: Build terminated for reason: Build Timeout Expired```
```

### Move Development Dependencies

Update your package.json to move testing and development tools to devDependencies:

Go to Settings → Config Vars and add:

```txt
NPM_CONFIG_PRODUCTION: false
NODE_ENV: production
```

This still does not work.

### Reduce the build time significantly

- create a .npmrc file in your project root
- Update your package.json to include only the essential dependencies
- Remove NPM_CONFIG_PRODUCTION

I'm starting to doubt if it will even be possible to deploy this app with Heroku.

One option would be to add an expensive Dyno type to increase the build timeout.

- Standard-1X ($25/month): 30 minute build timeout

I think that might be a good idea, but in general experience with Heroku is not really something that will improve my profile.

AWS or Azure would.  However, how much am I willing to pay for this feature?

Like the Satisfactory app which was only run locally, it might just be something I run on my laptop, and I give up the flexibility of using the feature on my phone "out in the field" so to speak.

Satisfactory is a monorepo with specific Python ML requirements and various front ends, and would have required considerable skills and experience to deploy.

Even after working with Django and Tensorflow, I was able to deploy such an app on AWS EC2 instances, but at a cost I was not willing to pay ($100 a month or thereabouts).

Maybe there is a separate approach that just involves curating the links needed that can be used on a phone to whip up a more manual workflow might be a more cost effective solution.

Another options would be to create an Docker image that can be deployed to an EC2 instance for a period of time when it's in use, and then removed when its not.

This would demonstrate some hirable skills as well as be a cost effective solution.

Its not idea, but until a platform can start to make money or be funded in some way, its not worth pouring money into.

## Docker image

- create a Dockerfile
- Create .dockerignore
- Build and test locally

First I launch the Docker app on my Windows machine.

Check its running and then build.

```sh
$ docker --version
Docker version 26.0.0, build 2ae903e
$ docker build -t google-trend-predictor .
$ docker run -p 3001:3001 google-trend-predictor
```

```sh
9.802 Warning: apt-key output should not be parsed (stdout is not a terminal)
11.04 OK
11.05 sh: 1: cannot create /etc/sources.list.d/google.list: Directory nonexistent
------
Dockerfile:5
--------------------
   4 |     # Install dependencies for Puppeteer
   5 | >>> RUN apt-get update \
   6 | >>>     && apt-get install -y wget gnupg \
   7 | >>>     && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add - \
   8 | >>>     && sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/sources.list.d/google.list' \
   9 | >>>     && apt-get update \
  10 | >>>     && apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1 \
  11 | >>>     --no-install-recommends \
  12 | >>>     && rm -rf /var/lib/apt/lists/*
  13 |
--------------------
ERROR: failed to solve: process "/bin/sh -c apt-get update     && apt-get install -y wget gnupg     && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt-key add -     && sh -c 'echo \"deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main\" >> /etc/sources.list.d/google.list'     && apt-get update     && apt-get install -y google-chrome-stable fonts-ipafont-gothic fonts-wqy-zenhei fonts-thai-tlwg fonts-kacst fonts-freefont-ttf libxss1     --no-install-recommends     && rm -rf /var/lib/apt/lists/*" did not complete successfully: exit code: 2
```

The error is because the sources.list.d directory doesn't exist.

To fix this we Add a ```mkdir -p /etc/apt/sources.list.d``` to create the directory and fix the path to ```/etc/apt/sources.list.d/google.list```.

Then, the build takes forever:

```sh
[+] Building 743.5s (12/12) FINISHED                                                                                                      docker:default
 => [internal] load build definition from Dockerfile                                                                                                0 0s
 => => transferring dockerfile: 986B                                                                                                                0.0s
 => [internal] load metadata for docker.io/library/node:16-slim                                                                                     1.1s
 => [internal] load .dockerignore                                                                                                                   0.0s
 => => transferring context: 86B                                                                                                                    0.0s
 => CACHED [1/7] FROM docker.io/library/node:16-slim@sha256:3ebf2875c188d22939c6ab080cfb1a4a6248cc86bae600ea8e2326aa03acdb8f                        0.0s
 => [internal] load build context                                                                                                                   0.0s
 => => transferring context: 17.50kB                                                                                                                0.0s
 => [2/7] RUN apt-get update     && apt-get install -y wget gnupg     && wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | apt  76.5s
 => [3/7] WORKDIR /usr/src/app                                                                                                                      0.0s
 => [4/7] COPY package*.json ./                                                                                                                     0.1s
 => [5/7] RUN npm install                                                                                                                         648.7s
 => [6/7] COPY . .                                                                                                                                  0.8s
 => [7/7] RUN npm run build                                                                                                                         5.2s
 => exporting to image                                                                                                                             10.8s
 => => exporting layers                                                                                                                            10.4s
 => => writing image sha256:a60b64401baf4cb5c49992609c5c2b6284351ee5777bcd8b68482317f5a4dc0d                                                        0.0s
 => => naming to docker.io/library/google-trend-predictor                                                                                           0.0s
 ```

 Yep, npm install takes 648.7 seconds.  That's how many minutes? About ten.

### unable to remove repository reference

```sh
> docker rmi google-trend-predictor
Error response from daemon: conflict: unable to remove repository reference "google-trend-predictor" (must force) - container 0f331994d7cb is using its referenced image a60b64401baf
```

You need to remove the container before removing the image. Here's the sequence:

```sh
# List all containers (including stopped ones)
docker ps -a

0f331994d7cb   google-trend-predictor   "docker-entrypoint.s…"   34 hours ago   Exited (1) 34 hours ago                              busy_nobel
de4c14041c26   postgres:14.2-alpine     "docker-entrypoint.s…"   4 months ago   Created                                              server-db-1
433c616e2c2f   postgres:14.2-alpine     "docker-entrypoint.s…"   4 months ago   Up 35 hours                 0.0.0.0:5432->5432/tcp   project-name-db-1
7ceb91085036   app-nginx                "/docker-entrypoint.…"   6 months ago   Exited (255) 5 months ago   0.0.0.0:1337->80/tcp     app-nginx-1
b696b3aedd25   app-web                  "/home/app/web/entry…"   6 months ago   Exited (255) 5 months ago   0.0.0.0:8000->8000/tcp   app-web-1
fb7a936a9f53   postgres:15              "docker-entrypoint.s…"   6 months ago   Exited (255) 5 months ago   5432/tcp                 app-db-1
347a52141309   postgres                 "docker-entrypoint.s…"   7 months ago   Exited (1) 7 months ago                              friendly_franklin
4687bf223246   postgres                 "docker-entrypoint.s…"   7 months ago   Exited (1) 7 months ago                              hopeful_shockley
e4bcf10d319f   django-gitlab-ec2-web    "/usr/src/app/entryp…"   7 months ago   Exited (255) 7 months ago   0.0.0.0:8000->8000/tcp   django-gitlab-ec2-web-1     
0c4e3e2ecf17   postgres:15              "docker-entrypoint.s…"   7 months ago   Exited (255) 7 months ago   5432/tcp                 django-gitlab-ec2-db-1  

# Stop the container
docker stop 0f331994d7cb

# Remove the container
docker rm 0f331994d7cb

# Now remove the image
docker rmi google-trend-predictor

Untagged: google-trend-predictor:latest
Deleted: sha256:a60b64401baf4cb5c49992609c5c2b6284351ee5777bcd8b68482317f5a4dc0d

# Build new image
docker build -t google-trend-predictor .

# Run new container
docker run -p 3001:3001 google-trend-predictor
```

I didn't have to wait ten minutes this time.  However, I see this error:

```sh
> docker run -p 3001:3001 google-trend-predictor
node:internal/modules/cjs/loader:1031
  throw err;
  ^
Error: Cannot find module '/usr/src/app/dist/main.js'
    at Function.Module._resolveFilename (node:internal/modules/cjs/loader:1028:15)
    at Function.Module._load (node:internal/modules/cjs/loader:873:27)
    at Function.executeUserEntryPoint [as runMain] (node:internal/modules/run_main:81:12)
    at node:internal/main/run_main_module:22:47 {
  code: 'MODULE_NOT_FOUND',
  requireStack: []
}
```

### Workflow

```sh
# Remove existing container and image
docker rm -f $(docker ps -a -q --filter ancestor=google-trend-predictor)
docker rmi google-trend-predictor

# Build with verbose output
docker build -t google-trend-predictor . --progress=plain

# Run the container
docker run -p 3001:3001 google-trend-predictor
```
